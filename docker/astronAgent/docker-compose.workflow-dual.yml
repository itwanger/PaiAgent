services:
  # ============================================================================
  # Workflow Services - 双版本隔离部署
  # ============================================================================
  
  # Python Workflow (原版本 - 生产稳定版)
  core-workflow-python:
    image: core-workflow:local
    container_name: astron-agent-core-workflow-python
    build:
      context: ../../
      dockerfile: core/workflow/Dockerfile
    environment:
      RUNTIME_ENV: "${RUNTIME_ENV:-dev}"
      SERVICE_PORT: "7880"
      MYSQL_HOST: "${MYSQL_HOST:-mysql}"
      MYSQL_PORT: "${MYSQL_PORT:-3306}"
      MYSQL_USER: "${MYSQL_USER:-root}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-root123}"
      MYSQL_DB: "workflow"  # 使用同一个数据库
      REDIS_CLUSTER_ADDR: "${REDIS_CLUSTER_ADDR}"
      REDIS_ADDR: "${REDIS_ADDR:-redis:6379}"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      REDIS_EXPIRE: "${REDIS_EXPIRE:-3600}"
      OSS_TYPE: "${OSS_TYPE:-s3}"
      OSS_ENDPOINT: "${OSS_ENDPOINT:-http://minio:9000}"
      OSS_ACCESS_KEY_ID: "${OSS_ACCESS_KEY_ID:-minioadmin}"
      OSS_ACCESS_KEY_SECRET: "${OSS_ACCESS_KEY_SECRET:-minioadmin123}"
      OSS_BUCKET_NAME: "${OSS_BUCKET_NAME}"
      OSS_DOWNLOAD_HOST: "${OSS_REMOTE_ENDPOINT}"
      OSS_TTL: "${OSS_TTL:-157788000}"
    volumes:
      - ./config/workflow-python/config.env:/opt/core/workflow/config.env
      - ./config/workflow-python/logs/:/opt/core/logs
    networks:
      - astron-agent-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7880/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Java Workflow (新版本 - 开发中)
  core-workflow-java:
    build:
      context: ../../core-workflow-java
      dockerfile: Dockerfile
    image: astron-agent-core-workflow-java:latest
    container_name: astron-agent-core-workflow-java
    ports:
      - "7881:7881"
    environment:
      # Spring Boot 配置
      SERVER_PORT: "7881"
      SPRING_APPLICATION_NAME: "core-workflow-java"
      
      # 数据库配置（独立数据库）
      MYSQL_HOST: "${MYSQL_HOST:-mysql}"
      MYSQL_PORT: "${MYSQL_PORT:-3306}"
      MYSQL_USER: "${MYSQL_USER:-root}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-root123}"
      MYSQL_DB: "workflow"  # 使用Python版本同一个数据库
      
      # Redis 配置
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      
      # 外部服务配置
      MODEL_SERVICE_URL: "http://console-hub:8080"
      AITOOLS_URL: "http://core-aitools:18668"
      PYTHON_WORKFLOW_URL: "http://core-workflow-python:7880"
      
      # JVM 配置
      JAVA_OPTS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"
    volumes:
      - ./config/workflow-java/logs/:/app/logs
    networks:
      - astron-agent-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:7881/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # 默认不启动，需要手动启动或使用 profile
    profiles:
      - java-workflow

networks:
  astron-agent-network:
    name: astronagent_astron-agent-network
    external: true
